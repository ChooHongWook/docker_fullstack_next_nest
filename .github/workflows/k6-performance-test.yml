name: k6 Performance Test

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'apps/backend/**'
      - 'k6/**'
      - '.github/workflows/k6-performance-test.yml'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - load

jobs:
  k6-test:
    name: Run k6 Performance Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file
        run: |
          cat > .env << EOF
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=postgres
          POSTGRES_DB=posts_db
          NEXT_PUBLIC_API_URL=http://localhost:4000
          FRONTEND_URL=http://localhost:3000
          NODE_ENV=test
          PORT=4000
          DATABASE_URL=postgresql://postgres:postgres@postgres:5432/posts_db
          EOF

      - name: Start services
        run: |
          docker-compose up -d postgres redis backend
          echo "‚è≥ Waiting for services to be ready..."
          sleep 10

      - name: Check backend health
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:4000/health; then
              echo "‚úÖ Backend is healthy"
              exit 0
            fi
            echo "‚è≥ Waiting for backend... ($i/30)"
            sleep 2
          done
          echo "‚ùå Backend health check failed"
          docker-compose logs backend
          exit 1

      - name: Run database migrations
        run: |
          docker-compose exec -T backend pnpm prisma:migrate:deploy

      - name: Seed test data
        run: |
          docker-compose exec -T backend pnpm prisma:db:seed

      - name: Determine test type
        id: test-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.test_type }}" >> $GITHUB_OUTPUT
          else
            echo "type=smoke" >> $GITHUB_OUTPUT
          fi

      - name: Run k6 Smoke Test
        if: steps.test-type.outputs.type == 'smoke'
        run: |
          docker-compose run --rm \
            -e BASE_URL=http://backend:4000 \
            -e K6_VUS=5 \
            k6 run /scripts/smoke-test.js

      - name: Run k6 Regression Test
        if: steps.test-type.outputs.type == 'regression'
        run: |
          docker-compose run --rm \
            -e BASE_URL=http://backend:4000 \
            k6 run /scripts/regression-test.js

      - name: Run k6 Load Test
        if: steps.test-type.outputs.type == 'load'
        run: |
          docker-compose run --rm \
            -e BASE_URL=http://backend:4000 \
            k6 run --out json=/results/load-ci-$(date +%Y%m%d-%H%M%S).json \
            /scripts/load-test.js

      - name: Parse test results (if load test)
        if: steps.test-type.outputs.type == 'load'
        run: |
          LATEST_RESULT=$(ls -t k6/results/*.json 2>/dev/null | head -1)
          if [ -n "$LATEST_RESULT" ]; then
            node scripts/parse-k6-results.js "$LATEST_RESULT"
          else
            echo "‚ö†Ô∏è  No results file found, skipping parsing"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-results-${{ steps.test-type.outputs.type }}
          path: k6/results/*.json
          retention-days: 7

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Backend Logs ==="
          docker-compose logs backend
          echo "=== PostgreSQL Logs ==="
          docker-compose logs postgres

      - name: Cleanup
        if: always()
        run: docker-compose down -v

  performance-gate:
    name: Performance Gate Check
    runs-on: ubuntu-latest
    needs: k6-test
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: k6-results-smoke
          path: k6/results/

      - name: Check performance thresholds
        run: |
          LATEST_RESULT=$(ls -t k6/results/*.json 2>/dev/null | head -1)
          if [ -n "$LATEST_RESULT" ]; then
            echo "üìä Checking performance thresholds..."
            if node scripts/parse-k6-results.js "$LATEST_RESULT"; then
              echo "‚úÖ Performance thresholds passed"
              exit 0
            else
              echo "‚ùå Performance thresholds failed"
              echo "Please review the performance regression before merging."
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  No results to check, skipping gate"
          fi

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const files = fs.readdirSync('k6/results/');
            if (files.length === 0) {
              console.log('No results to comment');
              return;
            }

            const latestFile = files.sort().reverse()[0];
            const data = JSON.parse(fs.readFileSync(`k6/results/${latestFile}`, 'utf8'));
            const metrics = data.metrics;

            const p95 = metrics.http_req_duration?.values['p(95)'] || 0;
            const errorRate = (metrics.http_req_failed?.values.rate || 0) * 100;
            const rps = metrics.http_reqs?.values.rate || 0;

            const body = `## üìä k6 Performance Test Results

            **Test Type**: Smoke Test
            **Status**: ${p95 < 200 && errorRate < 1 ? '‚úÖ Passed' : '‚ö†Ô∏è Warning'}

            | Metric | Value | Threshold | Status |
            |--------|-------|-----------|--------|
            | p95 Latency | ${p95.toFixed(2)}ms | < 200ms | ${p95 < 200 ? '‚úÖ' : '‚ùå'} |
            | Error Rate | ${errorRate.toFixed(2)}% | < 1% | ${errorRate < 1 ? '‚úÖ' : '‚ùå'} |
            | RPS | ${rps.toFixed(2)} | > 10 | ${rps > 10 ? '‚úÖ' : '‚ùå'} |

            <details>
            <summary>View detailed results</summary>

            \`\`\`json
            ${JSON.stringify(metrics, null, 2).slice(0, 2000)}
            \`\`\`
            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
